# Python CSFLE Example

## Steps

1. Clone this repository and navigate to the **python** directory.

   ```sh
   git clone https://github.com/mongodb-university/csfle-guides.git
   cd python
   ```

   Work from the **python** directory for the remainder of these instructions.

2. Start a locally running `mongod` instance (Enterprise version >= 4.2) running on port 27017

3. We recommend that you create a local environment to encapsulate the
   dependencies. We use [**pyenv**](https://realpython.com/intro-to-pyenv/)

   ```
   pyenv virtualenv 3.7.3 csfle
   pyenv local csfle
   pip install -r requirements.txt
   ```

   If you need to use AWS KMS, install the `pymongocrypt` library using the
   following command:

   ```
   pip install pymongocrypt==1.0.1
   ```

   If you need to use Azure or GCP KMS, you need to build and install the
   `pymongocrypt` library using our instructions on
   [how to build libmongocrypt from source](https://github.com/mongodb/libmongocrypt/tree/master/bindings/python#installing-from-source).

4. Make sure you have the `master-key.txt` file in the root of your execution
   environment. This is a 96-byte cryptographically-secure generated master
   encryption key required to run this example project. To generate your own
   master key or use a KMS, refer to the [CSFLE Use Case Guide](https://www.mongodb.com/docs/drivers/security/client-side-field-level-encryption-guide/).

   The settings for each supported KMS are included in `app.py`. If you are
   using a cloud KMS provider, uncomment and assign your KMS provider
   settings. See
   [Use a KMS to Store the Master Key Guide](https://www.mongodb.com/docs/drivers/security/client-side-field-level-encryption-local-key-to-kms)
   for more information on how to set up a master key and data encryption
   key with on of the supported KMS providers.


5. Run the `make_data_key.py` script to make a data key. If there is an
   existing data key in the **encryption.__keyVault** collection this script
   will not create a duplicate data key.

   ```python
   python make_data_key.py
   ```

   This outputs a base64 encoded string of the UUID of your newly created data key. Paste
   this into `app.py` where you see this line

   ```python
   # Insert your key generated by make_data_key.py here.
   # Or comment this out if you already have a data key for your provider stored.
   data_key = CsfleHelper.key_from_base64("<paste the output make_data_key.py here>")
   ```

6. Run the `app.py` script to insert a document with the CSFLE-enabled client
   and then read that document with it as well as a regular client. The
   CSFLE-enabled client prints the document out in plaintext, and the regular
   client prints the document out with encrypted fields in binary format.
   This is safe to run multiple times; the insert operation is called with
   an upsert option specified.

   ```python
   python app.py
   ```

7. Suggestion: Try inserting a document with the regular client. What happens?
